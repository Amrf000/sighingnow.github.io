---
title: Java对象初始化机制
author: He Tao
date: 2015-03-23
tag: [Java]
category: 编程语言
layout: post
---

<p>在Java里，对象的初始化工作主要由构造函数完成，除此之外，静态初始化和实例初始化会完成另外一部分初始化工作。</p>
<h2 id="构造函数初始化">构造函数初始化</h2>
<p>类的构造函数承担类的实例化工作，Java中，每次使用<code>new</code>来创建一个新的对象时，都会调用对象的对应参数类型的构造函数。</p>
<p>Java中，构造函数的定义如下：</p>
<blockquote>
<p>A constructor is used in the creation of an object that is an instance of a class.</p>
</blockquote>
<p><a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.8">文档</a></p>
<!--more-->
<h2 id="静态初始化">静态初始化</h2>
<p>静态初始化仅仅在类初始化(类加载)的时候进行，大多数情形下，也即第一次实例化的时候进行，此后不再运行静态初始化相关的程序内容。</p>
<p>静态初始化由两部分内容组成，一部分为<strong>静态</strong>变量定义时直接初始化，例如：</p>
<pre><code>private static String name = &quot;class name&quot;;</code></pre>
<p>除了定义时直接初始化，还有静态初始化代码块(Static Initializers):</p>
<pre><code>StaticInitializer:
    static Block</code></pre>
<blockquote>
<p>A static initializer declared in a class is executed when the class is initialized.</p>
</blockquote>
<p>关于Static Initializers的文档，<a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.6">祥见</a>。如果一个类中有多个静态<code>static</code>代码块，将按照这些代码块在程序中出现的先后顺序依次执行。</p>
<p>如果一个类有<code>main(String [] args)</code>作为程序入口，这个类中的<code>static</code>语句块也会比main函数中的语句先执行。比如：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">public</span> <span class="kw">class</span> Main {
    <span class="dt">static</span> {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;static block&quot;</span>);
    }
    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(String [] args) {
        System.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;main entry&quot;</span>);
    }
}</code></pre>
<p>编译，运行，在控制台得到如下输出：</p>
<pre><code>static block
main entry</code></pre>
<p>在直接通过类名来调用类的静态方法时，会首先调用类的静态代码块，或许，Java编译器在编译阶段便把所有static块的代码拷贝到了所有的static函数中（与下文中构造代码块被拷贝到构造函数中类似）。</p>
<p>由于static代码块具有这些性质，因此，很多初始化工作便可以通过static代码块的方式来放在类载入时执行，并且只执行一次。例如，在Java中载入C/C++编写的动态链接库时，便可以放在static代码块中进行。如下例：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="dt">static</span> {
    System.<span class="fu">loadLibrary</span>(<span class="st">&quot;Library&quot;</span>);
}</code></pre>
<h2 id="实例初始化">实例初始化</h2>
<p>实例初始化表示构造函数之外的，每次类实例化生成新的对象的时候都会执行的一段代码。一部分实例初始化工作在定义类的<strong>非静态</strong>变量时直接初始化完成，例如:</p>
<pre><code>private int id = 12345;</code></pre>
<p>此外，Java中还有一个构造代码块(Instance Initializers)的概念：</p>
<pre><code>InstanceInitializer:
    Block</code></pre>
<blockquote>
<p>An instance initializer declared in a class is executed when an instance of the class is created.</p>
</blockquote>
<p>关于构造代码块的更具体的定义，<a href="http://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.6">详见</a></p>
<p>Java编译器会将这段初始化代码块拷贝到构造函数中去。因此，这一语法可以用于多个构造函数（重载构造函数）共享同一段代码并减少代码冗余。</p>
<p>另一个实例初始化的方式是采用一个<code>final</code>函数来初始化变量，如下例：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Whatever {
    <span class="kw">private</span> varType myVar = <span class="fu">initializeInstanceVariable</span>();       
    <span class="kw">protected</span> <span class="dt">final</span> varType <span class="fu">initializeInstanceVariable</span>() {
        <span class="co">// initialization code goes here</span>
    }
}</code></pre>
<h2 id="单例模式">单例模式</h2>
<p>在一些应用场景下，某些类只允许有一个实例存在，这种设计模式称为单例模式，通过限制类的构造函数的访问权限，可以对类的实例化采取有效的控制。那么，对于构造函数为<code>private</code>的类，又如何得到类的实例呢？这时便需要用到<code>static</code>方法来获取类的实例。</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">class</span> Demo {
    <span class="kw">private</span> <span class="fu">Demo</span>() {
        <span class="co">// ....</span>
    }
    <span class="kw">public</span> <span class="dt">static</span> Demo <span class="fu">getInstance</span>() {
        <span class="kw">return</span> (<span class="kw">new</span> <span class="fu">Demo</span>());
    }
}</code></pre>
<p>参考(Reference)：</p>
<ol style="list-style-type: decimal">
<li><a href="http://docs.oracle.com/javase/specs/jls/se8/html/index.html">The Java® Language Specification</a></li>
<li><a href="http://docs.oracle.com/javase/tutorial/java/javaOO/initial.html">The Java™ Tutorials</a></li>
</ol>
<p><em>注:</em>测试环境：java version “1.8.0_40”</p>
