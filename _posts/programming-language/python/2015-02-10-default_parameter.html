---
title: Python 的默认参数
author: He Tao
date: 2015-02-10
tag: Python
category: 编程语言
layout: post
---

<p>Python的默认参数为编程带来了极大地便利，但同时误用默认参数也产生了不小的陷进。</p>
<h2 id="默认参数的求值">默认参数的求值</h2>
<p>在Python(34)的Documentation中，有这样一段叙述：</p>
<blockquote>
<p>Default parameter values are evaluated from left to right when the function definition is executed.</p>
</blockquote>
<p>Python的默认参数是从左向右求值。看下面这段代码：</p>
<pre class="sourceCode python"><code class="sourceCode python">param = [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>]

<span class="kw">def</span> func(a=param.copy(), b=param.sort(), c=param.copy()):
    <span class="dt">print</span>(a, b, c)

<span class="kw">if</span> <span class="ot">__name__</span> == <span class="st">&#39;__main__&#39;</span>:
    func()</code></pre>
<!--more-->
<p>按照Python默认参数从左到右求值的规则，有如下的输出结果：</p>
<pre><code>[1, 3, 2, 4] None [1, 2, 3, 4]</code></pre>
<p>再看如下一段代码：</p>
<pre class="sourceCode python"><code class="sourceCode python">param = [<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">2</span>, <span class="dv">4</span>]

<span class="kw">if</span> <span class="ot">__name__</span> == <span class="st">&#39;__main__&#39;</span>:
    <span class="dt">print</span>(param)

<span class="kw">def</span> func(a=param.copy(), b=param.sort(), c=param.copy()):
    <span class="dt">print</span>(a, b, c)

<span class="kw">if</span> <span class="ot">__name__</span> == <span class="st">&#39;__main__&#39;</span>:
    <span class="dt">print</span>(param)</code></pre>
<p>运行，得到如下输出：</p>
<pre><code>[1, 3, 2, 4]
[1, 2, 3, 4]</code></pre>
<p>出现以上现象的原因在于Python的默认参数是在运行<code>def</code>语句是进行求值的。默认参数只进行一次求值，之后每次调用函数是，都是用已经算出来的值(“pre-computed” value)。</p>
<h2 id="可变对象作为默认参数">可变对象作为默认参数</h2>
<p>将可变对象如<code>list</code>, <code>dict</code>等作为默认参数时，可能会改变对象的值，从而引起一些错误。在使用可变对象作为默认参数时，应当注意以下两个问题。</p>
<h3 id="可变对象的求值">可变对象的求值</h3>
<p>正如上文所讲到的，默认参数在函数定义时（<code>def</code>语句中）进行求值。同时，其求值顺序为从左至右。因此，要注意对默认参数求值时因可变对象的值改变而可能引起的错误。</p>
<h3 id="不会创建新对象">不会创建新对象</h3>
<p>使用可变对象作为默认参数时，参数可以在不创建新对象的情况下对参数对象进行修改。考虑如下一段代码的运行情况：</p>
<pre class="sourceCode python"><code class="sourceCode python">&gt;&gt;&gt; <span class="kw">def</span> func(param=[]):
    param.append(<span class="dv">1</span>)
    <span class="kw">return</span> param

&gt;&gt;&gt; func()
[<span class="dv">1</span>]
&gt;&gt;&gt; func()
[<span class="dv">1</span>, <span class="dv">1</span>]
&gt;&gt;&gt; func()
[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]</code></pre>
<p>可见，每次调用函数时并没有重新将<code>param</code>的值赋为<code>[]</code>，而是直接在原来的对象的基础上修改。这也正是默认参数仅仅在函数定义时求值的原因。</p>
<pre class="sourceCode python"><code class="sourceCode python">&gt;&gt;&gt; <span class="kw">def</span> func(param=[]):
    param.append(<span class="dv">1</span>)
    <span class="dt">print</span>(<span class="dt">id</span>(param))
    <span class="kw">return</span> param

&gt;&gt;&gt; func()
<span class="dv">29548216</span>
[<span class="dv">1</span>]
&gt;&gt;&gt; func()
<span class="dv">29548216</span>
[<span class="dv">1</span>, <span class="dv">1</span>]
&gt;&gt;&gt; func()
<span class="dv">29548216</span>
[<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>]
&gt;&gt;&gt; </code></pre>
<p>从上面这段代码的运行结果不难看出，<code>param</code>始终是同一对象。</p>
<h3 id="解决方法">解决方法</h3>
<p>为了避免程序中出现此类问题，应当用<code>None</code>作为默认参数，并且在函数开始的时候检查参数是否为<code>None</code>即可。</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> func(param=<span class="ot">None</span>):
    <span class="kw">if</span> param == <span class="ot">None</span>:
        ...
    ...</code></pre>
<p>有些情形下，直接将对象与<code>None</code>比较是否相等可能会导致一些警告信息(例如<code>Numpy</code>库中的某些对象)。可以用以下方式来解决这一问题：</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> func(param=<span class="ot">None</span>):
    <span class="kw">if</span> param is <span class="ot">None</span>:
        ...
    ...</code></pre>
<p>在Python(34)的Documentation中，有这样的叙述：</p>
<blockquote>
<p>This is generally not what was intended. A way around this is to use None as the default, and explicitly test for it in the body of the function.</p>
</blockquote>
<p>并给出了如下的一个示例：</p>
<pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> whats_on_the_telly(penguin=<span class="ot">None</span>):
    <span class="kw">if</span> penguin is <span class="ot">None</span>:
        penguin = []
    penguin.append(<span class="st">&quot;property of the zoo&quot;</span>)
    <span class="kw">return</span> penguin</code></pre>
<h2 id="默认参数的修改">默认参数的修改</h2>
<p>默认参数也是函数的一个属性(attribute)，可以像修改普通的函数属性那样修改默认参数的值。Python中国，函数的<code>__defaults__</code>属性是一个包含函数所有的默认参数的元组。</p>
<pre class="sourceCode python"><code class="sourceCode python">&gt;&gt;&gt; <span class="kw">def</span> func(param=<span class="dv">10</span>):
    <span class="dt">print</span>(param)

    
&gt;&gt;&gt; func()
<span class="dv">10</span>
&gt;&gt;&gt; func.__defaults__
(<span class="dv">10</span>,)
&gt;&gt;&gt; func.__defaults__ = ([<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>],)
&gt;&gt;&gt; func()
[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>]
&gt;&gt;&gt; func.__defaults__ = ()
&gt;&gt;&gt; func.__defaults__
()
&gt;&gt;&gt; func()
Traceback (most recent call last):
  File <span class="st">&quot;&lt;pyshell#25&gt;&quot;</span>, line <span class="dv">1</span>, in &lt;module&gt;
    func()
<span class="ot">TypeError</span>: func() missing <span class="dv">1</span> required positional argument: <span class="st">&#39;param&#39;</span>
&gt;&gt;&gt;</code></pre>
<p>可见，通过修改默认参数来改变函数的性质的方法也是可行的。</p>
<h2 id="参考">参考</h2>
<ol style="list-style-type: decimal">
<li><p><a href="http://effbot.org/zone/default-values.htm" class="uri" title="default-values">http://effbot.org/zone/default-values.htm</a></p></li>
<li><p><a href="https://docs.python.org/3/">Python Documentation</a></p></li>
</ol>
