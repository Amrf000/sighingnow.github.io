---
title: Java JNI 初探
author: He Tao
date: 2015-02-10
tag: [JNI, JVM, Java]
category: Runtime
layout: post
---

<h2 id="什么是-jni">什么是 JNI ？</h2>
<p>JNI(Java Native Interface)，Java 本地接口，是一个本机编程接口，提供了Java与C，C++语言的通信。JNI的主要实现方式为在Java中通过<code>System.loadLibrary</code>来加载C/C++编写的DLL。以此来调用C/C++实现的函数。</p>
<h2 id="java调用c">Java调用C++</h2>
<p>Java语言的写法：</p>
<pre class="sourceCode java"><code class="sourceCode java"><span class="kw">package com.dhdave.maker;</span>

<span class="co">/**</span>
<span class="co"> * </span><span class="kw">@author </span><span class="co">DHDave</span>
<span class="co"> * </span>
<span class="co"> */</span>
<span class="kw">public</span> <span class="kw">class</span> Maker {

    <span class="dt">static</span> {
        System.<span class="fu">loadLibrary</span>(<span class="st">&quot;Maker&quot;</span>);
    }

    <span class="fu">@SuppressWarnings</span>(<span class="st">&quot;javadoc&quot;</span>)
    <span class="kw">public</span> <span class="kw">native</span> <span class="dt">int</span> <span class="fu">DisplayMakerInfo</span>(String info);

    <span class="fu">@SuppressWarnings</span>(<span class="st">&quot;javadoc&quot;</span>)
    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(String[] args) {
        <span class="dt">int</span> length = (<span class="kw">new</span> <span class="fu">Maker</span>()).<span class="fu">DisplayMakerInfo</span>(<span class="st">&quot;Hello Maker JNI !&quot;</span>);
        System.<span class="fu">out</span>.<span class="fu">println</span>(length);
    }
}</code></pre>
<p>用<code>native</code>关键字定义的方法用C/C++实现。</p>
<!--more-->
<p>通过JDK中的javah工具来生成C/C++的头文件，在这之前，需要先编译java文件。</p>
<pre><code>javac com/dhdave/maker/Maker.java</code></pre>
<p>然后，用如下命令生成头文件：</p>
<pre><code>javah com.dhdave.maker.Maker</code></pre>
<p>得到文件名为<code>com_dhdave_maker_Maker.h</code>的头文件，头文件的内容如下所示：</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="co">/* DO NOT EDIT THIS FILE - it is machine generated */</span>
<span class="ot">#include &lt;jni.h&gt;</span>
<span class="co">/* Header for class com_dhdave_maker_Maker */</span>

<span class="ot">#ifndef _Included_com_dhdave_maker_Maker</span>
<span class="ot">#define _Included_com_dhdave_maker_Maker</span>
<span class="ot">#ifdef __cplusplus</span>
<span class="dt">extern</span> <span class="st">&quot;C&quot;</span> {
<span class="ot">#endif</span>
<span class="co">/*</span>
<span class="co"> * Class:     com_dhdave_maker_Maker</span>
<span class="co"> * Method:    DisplayMakerInfo</span>
<span class="co"> * Signature: (Ljava/lang/String;)I</span>
<span class="co"> */</span>
JNIEXPORT jint JNICALL Java_com_dhdave_maker_Maker_DisplayMakerInfo
  (JNIEnv *, jobject, jstring);

<span class="ot">#ifdef __cplusplus</span>
}
<span class="ot">#endif</span>
<span class="ot">#endif</span></code></pre>
<p>接下来创建一个同名的C++源文件来实现该头文件中定义的函数。</p>
<p>内容为：</p>
<pre class="sourceCode cpp"><code class="sourceCode cpp"><span class="ot">#include &lt;iostream&gt;</span>
<span class="ot">#include &lt;cstring&gt;</span>

<span class="ot">#include &quot;com_dhdave_maker_Maker.h&quot;</span>

<span class="kw">using</span> <span class="kw">namespace</span> std;

<span class="co">/**</span>
 * Author: DHDave (buaahetao<span class="er">@</span>gmai.com)
 */

JNIEXPORT jint JNICALL Java_com_dhdave_maker_Maker_DisplayMakerInfo
  (JNIEnv *env, jobject object, jstring info) 
{
    cout &lt;&lt; <span class="st">&quot;JNI method called!&quot;</span><span class="co"> </span>&lt;&lt; endl;

    <span class="dt">const</span> <span class="dt">char</span> *str = env-&gt;GetStringUTFChars(info, <span class="dv">0</span>);
    cout &lt;&lt; <span class="st">&quot;info: &quot;</span><span class="co"> </span>&lt;&lt; str &lt;&lt; endl;

    <span class="kw">return</span> strlen(str);
}

<span class="co">/* vim: set ts=4, sw = 4 */</span></code></pre>
<p>使用MinGW编译C++文件，得到动态链接库。编译命令为：</p>
<pre><code>g++ -shared -ID:/Java/jdk1.8.0_25/include -ID:/Java/jdk1.8.0_25/include/win32 -Wl,--add-stdcall-alias com_dhdave_maker_Maker.cpp -o Maker.dll</code></pre>
<p>编译成功后，会在当前目录得到一个名为“Maker.dll”的动态链接库。然后，使用如下命令运行：</p>
<pre><code>java com.dhdave.maker.maker</code></pre>
<p>得到如下输出：</p>
<pre><code>JNI method called!
info: Hello Maker JNI!
17</code></pre>
<p>说明Java字节码在运行时成功载入了动态链接库并成功运行了其中的函数。</p>
<p>在编译时一定要注意加上<code>-Wl,--add-stdcall-alias</code>选项，否则，可能会出现调用dll中的函数时找不到函数的错误。</p>
<p>运行时如果出现找不到dll的错误，可以通过制定<code>java.library.path</code>来解决。通过如下Java语句可以得到<code>java.library.path</code>的值：</p>
<pre><code>System.getProperty(&quot;java.library.path&quot;);</code></pre>
<h2 id="jni的数据类型">JNI的数据类型</h2>
<p>JNI中定义的数据类型如下表所示：</p>
<table>
<thead>
<tr class="header">
<th align="left">Type</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">jboolean</td>
<td align="left">Holds a Java programming language boolean. Unsigned 8 bits.</td>
</tr>
<tr class="even">
<td align="left">jint</td>
<td align="left">Holds a Java programming language int. Signed 32 bits.</td>
</tr>
<tr class="odd">
<td align="left">jlong</td>
<td align="left">Holds a Java programming language long. Signed 64 bits.</td>
</tr>
<tr class="even">
<td align="left">jfloat</td>
<td align="left">Holds a Java programming language float. 32 bits.</td>
</tr>
<tr class="odd">
<td align="left">jdouble</td>
<td align="left">Holds a Java programming language double. 64 bits.</td>
</tr>
<tr class="even">
<td align="left">jobject</td>
<td align="left">Holds a Java programming language object.</td>
</tr>
<tr class="odd">
<td align="left">jclass</td>
<td align="left">Holds a Java programming language class.</td>
</tr>
<tr class="even">
<td align="left">jvalue</td>
<td align="left">Is a union of all primitive types and jobject. Thus, holds any Java programming language value.</td>
</tr>
<tr class="odd">
<td align="left">jfieldID</td>
<td align="left">Identifies a Java programming language field. jfieldIDs returned by JVM TI functions and events may be safely stored.</td>
</tr>
<tr class="even">
<td align="left">jmethodID</td>
<td align="left">Identifies a Java programming language method, initializer, or constructor. jmethodIDs returned by JVM TI functions and events may be safely stored. However, if the class is unloaded, they become invalid and must not be used.</td>
</tr>
<tr class="odd">
<td align="left">JNIEnv</td>
<td align="left">Pointer to the JNI function table. Pointer to this (JNIEnv *) is a JNI environment. |</td>
</tr>
</tbody>
</table>
